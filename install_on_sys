#!/bin/bash
#
# GooeyDE Installer / Uninstaller
# Usage:
#   sudo ./install_gooeyde.sh        → install
#   sudo ./install_gooeyde.sh --uninstall  → uninstall

set -e

INSTALL_PREFIX="/usr/local"
BIN_DIR="$INSTALL_PREFIX/bin"
SHARE_DIR="$INSTALL_PREFIX/share/gooeyde"
SESSION_DIR="/usr/share/xsessions"
LOGFILE="$HOME.local/share/gooeyde-session.log"

# Colors
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
RED="\033[1;31m"
RESET="\033[0m"

# Files
BINARIES=("gooey_shell" "gooeyde_desktop" "gooeyde_appmenu" "gooeyde_systemsettings")
ASSETS_SRC="build/assets/"
SESSION_FILE="gooeyde.desktop"
SESSION_SCRIPT="gooey_session"

function install_all() {
    echo -e "${YELLOW}Installing GooeyDE...${RESET}"

    # Copy binaries
    for bin in "${BINARIES[@]}"; do
        if [ -f "build/$bin" ]; then
            echo "→ Installing $bin"
            install -m 755 "build/$bin" "$BIN_DIR/$bin"
        else
            echo -e "${RED}⚠ Missing: build/$bin${RESET}"
        fi
    done

    # Install session script
    echo "→ Installing session script"
    install -m 755 "$SESSION_SCRIPT" "$BIN_DIR/$SESSION_SCRIPT"

    # Copy assets
    echo "→ Copying assets"
    mkdir -p "$SHARE_DIR"
    cp -rf "$ASSETS_SRC" "$SHARE_DIR/"
    chmod -R 755 "$SHARE_DIR"

    # Install .desktop entry
    echo "→ Installing session entry"
    install -m 644 "$SESSION_FILE" "$SESSION_DIR/$SESSION_FILE"

    # Ensure user log directory exists
    mkdir -p "$(dirname "$LOGFILE")"
    touch "$LOGFILE"

    echo -e "${GREEN}✅ Installation complete!${RESET}"
    echo "Select 'GooeyDE' from your login manager."
}

function uninstall_all() {
    echo -e "${YELLOW}Uninstalling GooeyDE...${RESET}"

    # Remove binaries
    for bin in "${BINARIES[@]}"; do
        rm -f "$BIN_DIR/$bin"
    done
    rm -f "$BIN_DIR/$SESSION_SCRIPT"

    # Remove assets and session entry
    rm -rf "$SHARE_DIR"
    rm -f "$SESSION_DIR/$SESSION_FILE"

    echo -e "${GREEN}✅ Uninstallation complete!${RESET}"
}

# Ensure root privileges
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Please run as root (use sudo).${RESET}"
    exit 1
fi

# Parse arguments
if [[ "$1" == "--uninstall" ]]; then
    uninstall_all
else
    install_all
fi
